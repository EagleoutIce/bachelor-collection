%% iris icon network generator package
%% Florian Sihler, 2021-03-14
\ProvidesPackage{iris-ico-net}[2021/03/14 v1.0 iris icon network generator package]
\newif\ifiinet@setup@cpalette@
\DeclareOption{cpalette}{\iinet@setup@cpalette@true}
\DeclareOption{nocpalette}{\iinet@setup@cpalette@false}
\newif\ifiinet@setup@gradient@
\DeclareOption{gradient}{\iinet@setup@gradient@true}
\DeclareOption{nogradient}{\iinet@setup@gradient@false}
\newif\ifiinet@setup@pathfade@
\DeclareOption{pathfade}{\iinet@setup@pathfade@true}
\DeclareOption{nopathfade}{\iinet@setup@pathfade@false}
\newif\ifiinet@setup@frameblock@
\DeclareOption{frameblock}{\iinet@setup@frameblock@true}
\DeclareOption{noframeblock}{\iinet@setup@frameblock@false}
\DeclareOption{debug}{\let\iinet@debug\typeout}
\DeclareOption{nodebug}{\let\iinet@debug\@gobble}
\let\iinet@debug\@gobble

\ProcessOptions*
\RequirePackage{tikz,etoolbox}
\usetikzlibrary{backgrounds,decorations.markings}

\RequirePackage{iris-ico-net@register}
\RequirePackage{iris-ico-net@debug}

\RequirePackage{iris-ico-net@matrix}
\RequirePackage{iris-ico-net@block}
\RequirePackage{iris-ico-net@routing}

\def\iinet@init#1{%
    \pgfkeys{/iinet@keys,defaults,#1}%
    \setcounter{iinet@block@count}{0}%
}

\newcommand*\IrisIcoRandomNet[1][]{\IrisIcoNet[#1]{
    % TODO: use @for?
    \setcounter{iinet@block@a}{0}
    \@whilenum\value{iinet@block@a}<\iinet@block@max@count\do{%
        \iinet@draw@single@block
        \stepcounter{iinet@block@a}%
    }
    \iinet@debug@show@matrix% Debug :)
    \iinet@root@lines
}}

\newenvironment{iris@rootlayer}{\begin{pgfonlayer}{background}}{\end{pgfonlayer}}

\newcommand\IrisIcoNet[2][]{\begingroup
\iinet@init{#1}%
\begin{tikzpicture}[x=1pt,y=1pt,scale=\iinet@scale]
    \let\get\iinet@getblock
    \let\setblock\iinet@setblock
    \let\setblockrand\iinet@setblockrand
    \iinet@calcdiffs% 1)
    \iinet@setup@matrix% 2)
    \def\iinet@outer@path{(-\iinet@padding@x,-\iinet@padding@y) rectangle (\iinet@width+\iinet@padding@x,\iinet@height+\iinet@padding@y)}
    \path[use as bounding box,\if@iinet@drawframe iinet@frame\fi]\iinet@outer@path;
    \path[clip,iinet@outer@roundings] \iinet@outer@path;
    \if@iinet@drawgrid\begin{pgfonlayer}{background}
        \path[clip,iinet@outer@roundings] \iinet@outer@path;
        \draw[iinet@grid] (-\iinet@padding@x,-\iinet@padding@y) grid (\iinet@width+\iinet@padding@x,\iinet@height+\iinet@padding@y);
    \end{pgfonlayer}\fi
    \let\debugmatrix\iinet@debug@show@matrix
    \let\autoroot\iinet@root@lines
    \let\block\iinet@fronte@draw@block
    \let\root\iinet@dl@root
    \let\rootlayer\iris@rootlayer
    \let\endrootlayer\endiris@rootlayer
    #2
\end{tikzpicture}%
\endgroup}



\endinput