\def\filename{sirius}
\ProvidesPackage{\filename}[2021/07/18 EagleoutIce - allow to interface with the sirius shell script (currently private)]

\def\sirius@error@se{%
  \PackageError{\filename}{sirius is a python script and does require write18 (amongst other deps)}{}%
}

\RequirePackage{pdftexcmds,environ,pgfkeys}
% allow 1
\ifcase\pdf@shellescape\sirius@error@se\or\or\sirius@error@se\fi

\newcommand*\sirius{\@ifnextchar[\@sirius\@@sirius}
\def\@sirius[#1]#2{\typeout{casts: sirius #2 '#1'}\immediate\write18{sirius #2 '#1'}}
\def\@@sirius#1{\typeout{casts: sirius #1}\immediate\write18{sirius #1}}

\pgfkeys{%
  /sirius/.cd,
  api-version/.store in = \sirius@file@api@version,
  snapshots/.store in   = \sirius@file@snapshots,
  start-year/.store in  = \sirius@model@year@start,
  end-year/.store in    = \sirius@model@year@end,
  connectors/.store in  = \sirius@model@connectors,
  defaults/.style={
    api-version=6,snapshots=[],
    start-year=2020,end-year=2040,%
    connectors=[]%
  },
  /sirius/block/.cd,
  id/.store in             = \sirius@block@id,
  type/.store in           = \sirius@block@type,
  name/.store in           = \sirius@block@name,
  x/.store in              = \sirius@block@x,
  y/.store in              = \sirius@block@y,
  width/.store in          = \sirius@block@width,% TODO: Children
  canvas-height/.store in  = \sirius@block@canvasHeight,% TODO: Children
  defaults/.style={% TODO: bases
    id = \number\c@sirius@internal@id,
    type =  component,
    x = 0, y = 0, width = 300,canvas-height=0%
  }
}

\def\sirius@t{\string\"}

\long\def\sirius@Meta#1{{%
  ".title": "Sirius-Config",%
  ".description": "Automatically generated sirius configuration",%
  ".verbose": false,%
  "freshness": 10,
  "host": "http://0.0.0.0:8081",% TODO: configure
  ".check-host": true,%
  "payloads": % Only one that will nest itself
    #1%
}}

\long\def\sirius@Single#1#2{{%
  "#1": {%
    ".inline": "#2",% yet \string\' escape messes up sh. therefore we use good old hacks. '"'"' does not work as well, as json has problems with single quotes
    "model-view-positions64": { "x": 0, "y": 0 },
    "model-view-zooms64": [ 1 ]%
    % TODO: configure others
  }%
}}

\long\def\sirius@File#1#2#3{{
  \sirius@t apiVersion\sirius@t: #1,
  \sirius@t snapshots\sirius@t: #2,
  #3
}}

\long\def\sirius@Model#1#2#3#4{ \sirius@t model\sirius@t: {
  \sirius@t startYear\sirius@t: #1,
  \sirius@t endYear\sirius@t: #2,
  \sirius@t connectors\sirius@t: #3,
  \sirius@t rootBlocks\sirius@t: [#4]
}}

\def\sirius@Block{\@dblarg\@sirius@Block}
\def\@sirius@Block[#1]#2#3#4{%
  \global\advance\c@sirius@internal@id\@ne
  \edef\@blk@currid{\number\c@sirius@internal@id}%
  \pgfkeys{/sirius/block/.cd,defaults,#1,name=#2}%
\g@addto@macro\sirius@currentbody{{
  \sirius@t id\sirius@t: \sirius@t\sirius@block@id\sirius@t,
  \sirius@t type\sirius@t: \sirius@t\sirius@block@type\sirius@t,
  \sirius@t name\sirius@t: \sirius@t\sirius@block@name\sirius@t,
  \sirius@t position\sirius@t: { \sirius@t x\sirius@t: \sirius@block@x, \sirius@t y\sirius@t: \sirius@block@y },
  \sirius@t width\sirius@t: \sirius@block@width,
  \sirius@t canvasHeight\sirius@t: \sirius@block@canvasHeight,
  \sirius@t entries\sirius@t: [#3],
  \sirius@t children\sirius@t: [#4]%
}}}
\newcount\c@sirius@internal@id

% #2 is unique identifier for target filename
% TODO: support for multiple singles?
% Note Writing those directly does not work, as '\Block' has to perform
% key calculation that mess up the naive write routine...
\newcommand*\SiriusDraw{\begingroup\let\Block\sirius@Block \@SiriusDraw}% preconsume Block
\newcommand\@SiriusDraw[3][]{%
\pgfkeys{/sirius/.cd,defaults,#1}%
\c@sirius@internal@id0\relax
\let\sirius@currentbody\@empty % TODO: block nestings!
#3\relax
\def\@sirius@extra{\sirius@Meta{\sirius@Single{#2}{\sirius@File{\sirius@file@api@version}{\sirius@file@snapshots}{%
\sirius@Model{\sirius@model@year@start}{\sirius@model@year@end}{\sirius@model@connectors}{\sirius@currentbody}%
}}}}%
\typeout{sirius-draw is ready to spell-cast: \@sirius@extra}
\@sirius[\@sirius@extra]{.noouse-file}
\endgroup}


% TODO: give me block like interface:
% '\Block{}'... => Defintion file for sirius-generate or so
\endinput